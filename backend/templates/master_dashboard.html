{% extends "base.html" %}
{% block content %}

<style>
    .logout-btn {
        position:absolute;top:20px;right:20px;
        background:#d32f2f;color:white;padding:10px 16px;
        border-radius:6px;border:none;cursor:pointer;
    }
    .logout-btn:hover { background:#b71c1c; }

    .section-card {
        background:white;padding:20px;border-radius:10px;
        margin-top:20px;box-shadow:0 4px 10px rgba(0,0,0,0.1);
    }

    input, select {
        padding:10px;width:100%;margin-top:8px;
        border:1px solid #bbb;border-radius:6px;
    }

    .btn {
        padding:8px 14px;border:none;border-radius:6px;
        background:#1a237e;color:white;cursor:pointer;
        font-size:14px;
    }

    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px;border-bottom:1px solid #ddd; font-size:14px; }

    .badge { padding:4px 10px;border-radius:6px;color:white;font-size:12px; }
    .badge-pending { background:#ffa000; }
    .badge-verified { background:#43a047; }

    .table-box {
        max-height:300px;overflow-y:auto;margin-top:12px;
        border:1px solid #ddd;border-radius:6px;
    }
    .table-box::-webkit-scrollbar { width:8px; }
    .table-box::-webkit-scrollbar-thumb { background:#9e9e9e;border-radius:4px; }

    /* ---------- EDIT MODAL ---------- */
    #editModal {
        position:fixed;top:0;left:0;width:100%;height:100%;
        background:rgba(0,0,0,0.6);display:none;
        justify-content:center;align-items:center;
    }
    .edit-box {
        background:white;padding:25px;border-radius:10px;
        width:90%;max-width:400px;
    }
</style>

<button class="logout-btn" onclick="logoutUser()">Logout</button>

<h2 style="color:#1a237e;margin-top:60px;">Master Dashboard</h2>

<!-- ---------------------- CREATE USER ---------------------- -->
<div class="section-card">
    <h3>Create User</h3>
    <select id="role">
        <option value="student">Student</option>
        <option value="admin">Admin</option>
        <option value="super_admin">Super Admin</option>
    </select>

    <input id="username" placeholder="Username">
    <input id="password" placeholder="Password">

    <button class="btn" onclick="createUser()">Create User</button>
    <p id="createMsg"></p>
</div>

<!-- ---------------------- STUDENTS TABLE ---------------------- -->
<div class="section-card">
    <h3>All Students</h3>
    <button class="btn" onclick="loadStudents()">Refresh</button>

    <div class="table-box">
        <table id="studentsTable">
            <thead>
                <tr>
                    <th>Username</th><th>Name</th><th>Mobile</th><th>Email</th><th>College ID</th>
                    <th>Status</th><th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ---------------------- ADMINS TABLE ---------------------- -->
<div class="section-card">
    <h3>All Admins</h3>
    <button class="btn" onclick="loadAdmins()">Refresh</button>

    <div class="table-box">
        <table id="adminsTable">
            <thead>
                <tr>
                    <th>Username</th><th>Name</th><th>Mobile</th><th>Email</th><th>College ID</th>
                    <th>Status</th><th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- NOTIFICATIONS CARD -->
<div class="section-card">
    <h3>Notifications</h3>
    <p>View and send alerts to users.</p>
    <button class="btn" onclick="window.location='/notifications'">Open Notifications</button>
</div>
<!-- ========= NOTIFICATIONS ========== -->
<div class="card">
    <h3>Notifications</h3>

    <table class="table" id="notifyTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Message</th>
                <th>From</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- ---------------------- GEOFENCE ---------------------- -->
<div class="section-card">
    <h3>Set Attendance Geofence</h3>
    <input id="landmark" placeholder="Location Landmark">
    <button class="btn" onclick="setGeo()">Use My Current Location</button>
    <p id="geoMsg"></p>
</div>

<!-- ---------------------- EDIT MODAL ---------------------- -->
<div id="editModal">
    <div class="edit-box">
        <h3>Edit User</h3>
        <input id="edit_name" placeholder="Full Name">
        <input id="edit_mobile" placeholder="Mobile">
        <input id="edit_email" placeholder="Email">
        <input id="edit_college" placeholder="College ID">
        
        <button class="btn" onclick="saveEdit()">Save</button>
        <button class="btn" style="background:gray;" onclick="closeEdit()">Cancel</button>
        <p id="editMsg"></p>
    </div>
</div>

<script>

let currentEditId = null;

// ---------------- LOGOUT ----------------
function logoutUser() {
    fetch("/api/auth/logout")
    .then(() => window.location.href="/login");
}



// ---------------- CREATE USER ----------------
function createUser(){
    let data = {
        role: role.value,
        username: username.value,
        password: password.value
    };

    fetch("/api/master/create_user", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    })
    .then(r=>r.json())
    .then(d=>{
        createMsg.innerHTML = d.message;
        loadStudents();
        loadAdmins();
    });
}


// ---------------- LOAD STUDENTS ----------------
function loadStudents(){
    fetch("/api/master/students")
    .then(r=>r.json())
    .then(r=>{
        let tbody = document.querySelector("#studentsTable tbody");
        tbody.innerHTML = "";
        r.data.forEach(u=>{
            tbody.innerHTML += `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name ?? "-"}</td>
                    <td>${u.mobile ?? "-"}</td>
                    <td>${u.email ?? "-"}</td>
                    <td>${u.college_id ?? "-"}</td>
                    <td>${u.is_verified ? 
                        "<span class='badge badge-verified'>Verified</span>" : 
                        "<span class='badge badge-pending'>Pending</span>"} 
                    </td>
                    <td>
                        <button class='btn' onclick="openEdit(${u.id}, '${u.name}', '${u.mobile}', '${u.email}', '${u.college_id}')">Edit</button>
                        <button class='btn' onclick="deleteUser(${u.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    });
}

/* ----------------------- LOAD NOTIFICATIONS ----------------------- */
function loadNotifications() {
    fetch("/api/notifications/list", { credentials:"include" })
    .then(r=>r.json())
    .then(d=>{
        let tbody = document.querySelector("#notifyTable tbody");
        tbody.innerHTML = "";

        d.data.forEach(n=>{
            tbody.innerHTML += `
                <tr>
                    <td><b>${n.title}</b></td>
                    <td class="notice-msg">${n.message}</td>
                    <td>${n.sender_name}</td>
                    <td>${n.timestamp}</td>
                </tr>
            `;
        });
    });
}

// ---------------- LOAD ADMINS ----------------
function loadAdmins(){
    fetch("/api/master/admins")
    .then(r=>r.json())
    .then(r=>{
        let tbody = document.querySelector("#adminsTable tbody");
        tbody.innerHTML = "";
        r.data.forEach(u=>{
            tbody.innerHTML += `
                <tr>
                    <td>${u.username}</td>
                    <td>${u.name ?? "-"}</td>
                    <td>${u.mobile ?? "-"}</td>
                    <td>${u.email ?? "-"}</td>
                    <td>${u.college_id ?? "-"}</td>
                    <td>${u.is_verified ? 
                        "<span class='badge badge-verified'>Verified</span>" : 
                        "<span class='badge badge-pending'>Pending</span>"} 
                    </td>
                    <td>
                        <button class='btn' onclick="openEdit(${u.id}, '${u.name}', '${u.mobile}', '${u.email}', '${u.college_id}')">Edit</button>
                        <button class='btn' onclick="deleteUser(${u.id})">Delete</button>
                    </td>
                </tr>
            `;
        });
    });
}


// ---------------- OPEN / CLOSE EDIT MODAL ----------------
function openEdit(id, name, mobile, email, college){
    currentEditId = id;

    edit_name.value = name === "null" ? "" : name;
    edit_mobile.value = mobile === "null" ? "" : mobile;
    edit_email.value = email === "null" ? "" : email;
    edit_college.value = college === "null" ? "" : college;

    editModal.style.display = "flex";
}

function closeEdit(){
    editModal.style.display = "none";
}


// ---------------- SAVE EDIT ----------------
function saveEdit(){
    let data = {
        name: edit_name.value,
        mobile: edit_mobile.value,
        email: edit_email.value,
        college_id: edit_college.value
    };

    fetch(`/api/master/edit/${currentEditId}`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    })
    .then(r=>r.json())
    .then(res=>{
        editMsg.innerHTML = res.message;
        setTimeout(()=>{
            closeEdit();
            loadStudents();
            loadAdmins();
        }, 800);
    });
}


// ---------------- DELETE USER ----------------
function deleteUser(id){
    fetch(`/api/master/delete/${id}`, {method:"DELETE"})
    .then(r=>r.json())
    .then(res=>{
        alert(res.message);
        loadStudents();
        loadAdmins();
    });
}


// ---------------- SET GEOFENCE ----------------
function setGeo(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let data = {
            landmark: landmark.value,
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
        };

        fetch("/api/master/set_geofence", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(data)
        })
        .then(r=>r.json())
        .then(res=>{
            geoMsg.innerHTML = res.message;
        });
    });
}
</script>

{% endblock %}

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Master Dashboard</title>

<style>
/* -------------------------------------- VARIABLES -------------------------------------- */
:root {
    --sky-blue: #00B4D8;
    --dark-blue: #0077B6;
    --purple: #7209B7;
    --light-pink: #F72585;
    --yellow: #FFD60A;
    --text-light: #F4F7F9;
    --text-dark: #333;
    --background: #F5F7FA;
    --card-bg: #ffffff;
    --sidebar-width: 260px;
}

*{margin:0;padding:0;box-sizing:border-box;}

/* -------------------------------------- BODY -------------------------------------- */
body{
    font-family:'Segoe UI',Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,#E3F2FD,#F8BBD0,#FFF9C4,#E1BEE7);
    background-size:400% 400%;
    animation:backgroundFlow 15s ease infinite;
    color:#333;
}

/* -------------------------------------- HEADER -------------------------------------- */
.header {
    background: linear-gradient(135deg,var(--dark-blue),var(--purple),var(--light-pink),var(--sky-blue));
    color:white;
    padding:12px 20px;
    position:fixed;top:0;width:100%;
    z-index:100;
    display:flex;align-items:center;
}
.menu-icon { font-size:28px;cursor:pointer;margin-right:20px; }

.header-title {
    font-size:1.6rem;
    font-weight:700;
    background:linear-gradient(90deg,#fff,var(--yellow),#fff);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}

.user-info {
    position:absolute;
    right:20px; top:12px;
    font-size:14px;
    color:#fff;
    background:rgba(255,255,255,0.2);
    padding:6px 14px;
    border-radius:20px;
}

/* -------------------------------------- SIDEBAR -------------------------------------- */
.sidebar{
    height:100vh;width:0;
    background:linear-gradient(180deg,var(--purple),var(--dark-blue),var(--sky-blue));
    position:fixed;top:0;left:0;
    padding-top:65px;
    overflow:hidden;
    transition:.4s;
}
.sidebar.open{ width:var(--sidebar-width); }

.sidebar a{
    display:block;padding:16px 25px;color:white;
    border-bottom:1px solid rgba(255,255,255,0.1);
    font-size:1rem;text-decoration:none;
}
.sidebar a:hover{ background:rgba(255,255,255,0.2); }

.logout-btn{
    margin:20px;padding:12px 25px;
    background:#d32f2f;color:white;border:none;
    border-radius:8px;cursor:pointer;width:calc(100% - 40px);
}
.logout-btn:hover{ background:#b71c1c; }

/* -------------------------------------- MAIN CONTENT -------------------------------------- */
.main-content{
    padding-top:90px;padding:20px;
}

/* -------------------------------------- TABLE CARD -------------------------------------- */
.table-card{
    background:white;
    padding:20px;
    border-radius:14px;
    margin-bottom:25px;
    box-shadow:0 4px 20px rgba(0,0,0,0.1);
}

.table-card h3{
    margin-bottom:12px;
    color:#1a237e;
}

/* SEARCH BAR */
.search-box input{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #aaa;
    margin-bottom:12px;
}

/* TABLE */
table{ width:100%;border-collapse:collapse; }
th{
    background:#1a237e;color:white;
    padding:12px;position:sticky;top:0;
}
td{ padding:10px;background:white;border-bottom:1px solid #ddd; }

.selfie-img{
    width:55px;height:55px;object-fit:cover;
    border-radius:8px;
}

.verified{ background:#4caf50;color:white;padding:4px 10px;border-radius:12px;font-size:12px; }
.pending{ background:#ffa000;color:white;padding:4px 10px;border-radius:12px;font-size:12px; }

.btn-edit{
    background:#0277bd;color:white;padding:6px 12px;border:none;
    border-radius:6px;cursor:pointer;
}
.btn-del{
    background:#d32f2f;color:white;padding:6px 12px;border:none;
    border-radius:6px;cursor:pointer;
}

/* -------------------------------------- MODAL -------------------------------------- */
.modal-bg{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.5);
    display:none;align-items:center;justify-content:center;
}

.modal-card{
    width:90%;max-width:400px;
    background:white;padding:20px;
    border-radius:10px;
}

.modal-card input{
    width:100%;padding:10px;
    border-radius:6px;border:1px solid #aaa;
    margin-bottom:10px;
}
</style>
</head>

<body>

<!-- ---------------------- HEADER ---------------------- -->
<div class="header">
    <span class="menu-icon" onclick="toggleSidebar()">&#9776;</span>
    <h2 class="header-title">Master Dashboard</h2>
    <span class="user-info" id="userInfo">User: -</span>
</div>

<!-- ---------------------- SIDEBAR ---------------------- -->
<div id="sidebar" class="sidebar">
    <a href="/master/dashboard">üè† Dashboard</a>
    <a href="/master/master_students">üìö Student List</a>
    <a href="/master/master_admins">üë• Admin List</a>
    <a href="/master/attendance_table">üìù Attendance</a>
    <a href="/master/notification">üîî Notifications</a>

    <button class="logout-btn" onclick="logoutUser()">Logout</button>
</div>

<!-- ---------------------- MAIN CONTENT ---------------------- -->
<div class="main-content">

    <!-- CREATE USER -->
    <div class="table-card">
        <h3>Create User</h3>
        <select id="role">
            <option value="student">Student</option>
            <option value="admin">Admin</option>
            <option value="super_admin">Super Admin</option>
        </select>
        <input id="username" placeholder="Username">
        <input id="password" placeholder="Password">

        <button onclick="createUser()">Create</button>
        <p id="createMsg"></p>
    </div>

    <!-- STUDENT TABLE -->
    <div class="table-card">
        <h3>Students</h3>

        <div class="search-box">
            <input id="searchStudents" placeholder="Search student..." onkeyup="filterStudents()">
        </div>

        <table id="studentsTable">
            <thead>
                <tr>
                    <th>Username</th><th>Name</th><th>Mobile</th><th>Email</th>
                    <th>College ID</th><th>Status</th><th>Edit</th><th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ADMIN TABLE -->
    <div class="table-card">
        <h3>Admins</h3>

        <div class="search-box">
            <input id="searchAdmins" placeholder="Search admin..." onkeyup="filterAdmins()">
        </div>

        <table id="adminsTable">
            <thead>
                <tr>
                    <th>Username</th><th>Name</th><th>Mobile</th><th>Email</th>
                    <th>College ID</th><th>Selfie</th><th>Status</th><th>Edit</th><th>Delete</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

</div>

<!-- ---------------------- EDIT MODAL ---------------------- -->
<div id="modal" class="modal-bg">
    <div class="modal-card">
        <h3>Edit User</h3>

        <input id="edit_name" placeholder="Full Name">
        <input id="edit_mobile" placeholder="Mobile">
        <input id="edit_email" placeholder="Email">
        <input id="edit_college_id" placeholder="College ID">

        <button class="btn-edit" onclick="saveEdit()">Save</button>
        <button class="btn-del" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
/* ---------------------- SIDEBAR ---------------------- */
function toggleSidebar(){
    document.getElementById("sidebar").classList.toggle("open");
}

/* ---------------------- USER TOP BAR ---------------------- */
let user = JSON.parse(localStorage.getItem("user"));
if(user){
    document.getElementById("userInfo").innerHTML = user.username + " (" + user.role + ")";
}

/* ---------------------- LOGOUT ---------------------- */
function logoutUser(){
    fetch("/api/auth/logout")
    .then(()=>{
        localStorage.clear();
        window.location.href="/login";
    });
}

/* ---------------------- CREATE USER ---------------------- */
function createUser(){
    let obj = {
        role: role.value,
        username: username.value,
        password: password.value
    };

    fetch("/api/master/create_user", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(obj)
    })
    .then(r=>r.json())
    .then(d=>{
        createMsg.innerHTML = d.message;
        loadStudents();
        loadAdmins();
    });
}

/* ---------------------- STUDENT TABLE ---------------------- */
function loadStudents(){
    fetch("/api/master/students")
    .then(r=>r.json())
    .then(res=>{
        let tbody = document.querySelector("#studentsTable tbody");
        tbody.innerHTML = "";

        res.data.forEach(s=>{
            tbody.innerHTML += `
                <tr>
                    <td>${s.username}</td>
                    <td>${s.name || "-"}</td>
                    <td>${s.mobile || "-"}</td>
                    <td>${s.email || "-"}</td>
                    <td>${s.college_id || "-"}</td>
                    <td>${s.is_verified ? 
                        "<span class='verified'>Verified</span>" :
                        "<span class='pending'>Pending</span>"
                    }</td>

                    <td><button class="btn-edit"
                        onclick="openEdit(${s.id}, '${s.name}', '${s.mobile}', '${s.email}', '${s.college_id}')">
                        Edit
                    </button></td>

                    <td><button class="btn-del" onclick="deleteUser(${s.id})">Delete</button></td>
                </tr>
            `;
        });
    });
}

function filterStudents(){
    let val = searchStudents.value.toLowerCase();
    let rows = document.querySelectorAll("#studentsTable tbody tr");
    rows.forEach(r=> r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none");
}

/* ---------------------- ADMIN TABLE ---------------------- */
function loadAdmins(){
    fetch("/api/master/admins")
    .then(r=>r.json())
    .then(res=>{
        let tbody = document.querySelector("#adminsTable tbody");
        tbody.innerHTML = "";

        res.data.forEach(a=>{
            let selfieHtml = a.selfie
                ? `<img src="/${a.selfie}" class="selfie-img">`
                : `<span style="color:#888;">No Image</span>`;

            tbody.innerHTML += `
                <tr>
                    <td>${a.username}</td>
                    <td>${a.name || "-"}</td>
                    <td>${a.mobile || "-"}</td>
                    <td>${a.email || "-"}</td>
                    <td>${a.college_id || "-"}</td>
                    <td>${selfieHtml}</td>
                    <td>${a.is_verified ? "<span class='verified'>Verified</span>" : "<span class='pending'>Pending</span>"}</td>

                    <td>
                        <button class="btn-edit" 
                        onclick="openEdit(${a.id}, '${a.name}', '${a.mobile}', '${a.email}', '${a.college_id}')">Edit</button>
                    </td>

                    <td><button class="btn-del" onclick="deleteUser(${a.id})">Delete</button></td>
                </tr>
            `;
        });
    });
}

function filterAdmins(){
    let val = searchAdmins.value.toLowerCase();
    let rows = document.querySelectorAll("#adminsTable tbody tr");
    rows.forEach(r=> r.style.display = r.innerText.toLowerCase().includes(val) ? "" : "none");
}

/* ---------------------- MODAL ---------------------- */
let currentID = null;

function openEdit(id, name, mobile, email, college_id){
    currentID = id;
    edit_name.value = name;
    edit_mobile.value = mobile;
    edit_email.value = email;
    edit_college_id.value = college_id;

    modal.style.display = "flex";
}

function closeModal(){
    modal.style.display = "none";
}

/* ---------------------- SAVE EDIT ---------------------- */
function saveEdit(){
    let data = {
        name: edit_name.value,
        mobile: edit_mobile.value,
        email: edit_email.value,
        college_id: edit_college_id.value
    };

    fetch(`/api/master/edit/${currentID}`, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(data)
    })
    .then(r=>r.json())
    .then(res=>{
        alert(res.message);
        closeModal();
        loadStudents();
        loadAdmins();
    });
}

/* ---------------------- DELETE ---------------------- */
function deleteUser(id){
    if(!confirm("Delete user?")) return;

    fetch(`/api/master/delete/${id}`, {method:"DELETE"})
    .then(r=>r.json())
    .then(res=>{
        alert(res.message);
        loadStudents();
        loadAdmins();
    });
}

/* ---------------------- INITIAL LOAD ---------------------- */
loadStudents();
loadAdmins();

</script>

</body>
</html>

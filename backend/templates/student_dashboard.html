{% extends "base.html" %}
{% block content %}

<style>
/* -------------------- Page Title -------------------- */
.page-title {
    color:#1a237e;
    font-size:28px;
    font-weight:700;
    margin-top:20px;
    margin-bottom:25px;
}

/* -------------------- Cards -------------------- */
.card {
    background: white;
    padding:22px;
    border-radius:14px;
    margin-top:25px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    transition:0.25s ease;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow:0 10px 25px rgba(0,0,0,0.12);
}

/* -------------------- Buttons -------------------- */
.btn {
    padding:12px 18px;
    border:none;
    border-radius:8px;
    background:#1a237e;
    color:white;
    cursor:pointer;
    margin-top:10px;
    transition:0.25s;
    font-size:15px;
    font-weight:600;
}
.btn:hover {
    background:#0d1450;
}

.disabled-btn {
    background: #9e9e9e !important;
    cursor: not-allowed;
}

/* -------------------- Upload Inputs -------------------- */
.card input {
    padding:10px;
    width:100%;
    border-radius:8px;
    border:1px solid #ccc;
    margin-top:10px;
}

/* -------------------- Tables -------------------- */
.table {
    width:100%;
    border-collapse:collapse;
    margin-top:15px;
}

.table thead {
    background:#1a237e;
    color:white;
}

.table th,
.table td {
    padding:12px;
    border-bottom:1px solid #ddd;
    text-align:left;
    font-size:14px;
}

.table tr:hover {
    background:#f1f1f1;
}

/* Tick for present */
.tick {
    color: green;
    font-size:20px;
    font-weight:bold;
}

/* Notification message styling */
.notice-msg {
    font-weight:600;
    color:#1a237e;
}

</style>

<!-- TITLE -->
<h2 class="page-title">Student Dashboard</h2>

<!-- ========= MARK ATTENDANCE ========== -->
<div class="card">
    <h3>Mark Attendance</h3>
    <p style="color:#555; margin-top:5px;">Mark your attendance using GPS verification.</p>

    <button class="btn disabled-btn" id="markBtn" disabled>Mark Now</button>
    <p id="attMsg" style="margin-top:10px;"></p>
</div>
<!-- ========= NOTIFICATIONS ========== -->
<div class="card">
    <h3>Notifications</h3>

    <table class="table" id="notifyTable">
        <thead>
            <tr>
                <th>Title</th>
                <th>Message</th>
                <th>From</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- ========= UPLOAD TRIP PHOTOS ========== -->
<div class="card">
    <h3>Upload Trip Photo</h3>

    <input type="file" id="photo">
    <input id="desc" placeholder="Description">

    <button class="btn" onclick="uploadPic()">Upload</button>
    <p id="uploadMsg"></p>
</div>


<!-- ========= MY ATTENDANCE ========== -->
<div class="card">
    <h3>My Attendance</h3>

    <button class="btn" onclick="loadAttendance()">Load Attendance</button>

    <table class="table" id="attTable">
        <thead>
            <tr>
                <th>Status</th>
                <th>Landmark</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>


<script>
let CURRENT_USER = null;

/* ----------------------- CHECK LOGIN ----------------------- */
document.addEventListener("DOMContentLoaded", () => {
    fetch("/api/auth/check", { credentials:"include" })
    .then(r => r.json())
    .then(res => {
        if (!res.logged_in) return window.location.href = "/login";

        CURRENT_USER = res.user;
        checkGeoStatus();
        loadNotifications();  // load when page opens
    });
});

/* ----------------------- CHECK GEOFENCE ----------------------- */
function checkGeoStatus() {
    fetch("/api/student/geofence_status")
    .then(r => r.json())
    .then(res => {
        let btn = document.getElementById("markBtn");

        if (!res.enabled) {
            btn.disabled = true;
            btn.innerText = "Attendance Not Available";
            btn.classList.add("disabled-btn");
            return;
        }

        btn.disabled = false;
        btn.classList.remove("disabled-btn");
        btn.innerText = "Mark Now";
        btn.onclick = markAttendance;
    });
}

/* ----------------------- MARK ATTENDANCE ----------------------- */
function markAttendance() {
    navigator.geolocation.getCurrentPosition(pos => {

        const data = {
            user_id: CURRENT_USER.id,
            marked_lat: pos.coords.latitude,
            marked_lng: pos.coords.longitude
        };

        fetch("/api/student/mark_attendance", {
            method:"POST",
            headers: { "Content-Type":"application/json" },
            credentials:"include",
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(d => {
            let msg = document.getElementById("attMsg");
            let btn = document.getElementById("markBtn");

            msg.innerHTML = d.message;
            msg.style.color = d.success ? "green" : "red";

            if (d.success || d.already_marked) {
                btn.disabled = true;
                btn.classList.add("disabled-btn");
                btn.innerText = "Attendance Marked";
            }
        });

    }, () => alert("Enable GPS to mark attendance."));
}

/* ----------------------- UPLOAD PHOTO ----------------------- */
function uploadPic() {
    let fileInput = document.getElementById("photo");

    if (!fileInput.files.length) return alert("Select a photo!");

    let form = new FormData();
    form.append("description", document.getElementById("desc").value);
    form.append("file", fileInput.files[0]);

    fetch("/api/student/upload", {
        method:"POST",
        credentials:"include",
        body: form
    })
    .then(r => r.json())
    .then(d => {
        let msg = document.getElementById("uploadMsg");
        msg.textContent = d.message;
        msg.style.color = d.success ? "green" : "red";
    });
}

/* ----------------------- LOAD ATTENDANCE ----------------------- */
function loadAttendance() {
    fetch("/api/student/my_attendance", { credentials:"include" })
    .then(r => r.json())
    .then(d => {

        let tbody = document.querySelector("#attTable tbody");
        tbody.innerHTML = "";

        d.data.forEach(x => {
            tbody.innerHTML += `
                <tr>
                    <td>${x.status === "present" ? "<span class='tick'>✔</span>" : "Absent"}</td>
                    <td>${x.landmark || "—"}</td>
                    <td>${x.timestamp}</td>
                </tr>
            `;
        });
    });
}

/* ----------------------- LOAD NOTIFICATIONS ----------------------- */
function loadNotifications() {
    fetch("/api/notifications/list", { credentials:"include" })
    .then(r=>r.json())
    .then(d=>{
        let tbody = document.querySelector("#notifyTable tbody");
        tbody.innerHTML = "";

        d.data.forEach(n=>{
            tbody.innerHTML += `
                <tr>
                    <td><b>${n.title}</b></td>
                    <td class="notice-msg">${n.message}</td>
                    <td>${n.sender_name}</td>
                    <td>${n.timestamp}</td>
                </tr>
            `;
        });
    });
}

</script>

{% endblock %}

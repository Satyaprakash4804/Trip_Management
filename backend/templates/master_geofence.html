{% extends "base.html" %}
{% block content %}

<style>
.map-box {
    width: 100%;
    height: 340px;
    border-radius: 12px;
    overflow: hidden;
    margin-top: 15px;
}
.section-card {
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
    margin-top:20px;
}
input {
    width:100%;
    padding:12px;
    margin-top:8px;
    border-radius:8px;
    border:1px solid #ccc;
}
.btn {
    background:#1a237e;
    color:white;
    padding:10px 16px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    margin-top:10px;
}
.btn:hover {
    background:#0e1755;
}
.table-box {
    margin-top:20px;
    max-height:350px;
    overflow:auto;
}
table {
    width:100%;
    border-collapse: collapse;
}
th {
    background:#1a237e;
    color:white;
    padding:10px;
    font-size:15px;
    position:sticky;
    top:0;
}
td {
    padding:8px;
    background:white;
    font-size:14px;
    border-bottom:1px solid #ddd;
}
tr:hover td {
    background: #eef1ff;
}
#msg {
    margin-top: 10px;
    font-weight: 600;
}
</style>

<h2 style="color:#1a237e;">Set Geofence</h2>

<!-- ====================== GEOFENCE SECTION ====================== -->
<div class="section-card">
    <label>Landmark <span style="color:red">*</span></label>
    <input id="landmark" placeholder="Enter Landmark" required>

    <label>Radius (meters)</label>
    <input id="radius" type="number" value="200" required>

    <label>Valid For (Minutes)</label>
    <input id="valid_minutes" type="number" value="60" required>

    <p style="margin-top:10px;">Click on map to pick location</p>

    <div id="map" class="map-box"></div>

    <button class="btn" onclick="useMyLocation()">Use My Current Location</button>
    <button class="btn" onclick="saveFence()">Save Geofence</button>

    <p id="msg"></p>
</div>

<!-- ====================== HISTORY SECTION ====================== -->
<h2 style="margin-top:30px; color:#1a237e;">Geofence History</h2>

<div class="section-card table-box">
    <table>
        <thead>
            <tr>
                <th>Landmark</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Set Time</th>
                <th>Expires At</th>
                <th>Attendance Count</th>
            </tr>
        </thead>
        <tbody id="geoTable"></tbody>
    </table>
</div>

<!-- MAPPLS SDK -->
<script src="https://apis.mappls.com/advancedmaps/api/cc411a189dd0edd91167de276484ce2d/map_sdk?layer=vector&v=3.0"></script>

<script>
let map;
let marker;

/* ------------------------ INIT MAP ------------------------ */
function initMap() {
    map = new mappls.Map("map", {
        center: {lat: 28.6139, lng: 77.2090},
        zoom: 12
    });

    map.on("click", function(e){
        console.log("Map Click:", e);
        
        let lat = e.lat || e.latitude;
        let lng = e.lng || e.longitude;

        if(!lat || !lng){
            console.error("Map click missing coordinates");
            return;
        }

        setMarker(lat, lng);
    });
}

/* ------------------------ PLACE MARKER ------------------------ */
function setMarker(lat, lng){
    if(marker){ marker.remove(); }

    marker = new mappls.Marker({
        map: map,
        position: {lat: lat, lng: lng}
    });

    window.pick_lat = lat;
    window.pick_lng = lng;
}

/* ------------------------ USE GPS LOCATION ------------------------ */
function useMyLocation(){
    navigator.geolocation.getCurrentPosition(pos=>{
        let lat = pos.coords.latitude;
        let lng = pos.coords.longitude;

        setMarker(lat, lng);
        map.setCenter({lat, lng});
        map.setZoom(15);
    }, () => {
        alert("Enable GPS permission to use this feature.");
    });
}

/* ------------------------ SAVE GEOFENCE ------------------------ */
function saveFence(){
    let msg = document.getElementById("msg");
    msg.innerHTML = "";

    // Validation
    if(landmark.value.trim() === ""){
        msg.style.color = "red";
        msg.innerHTML = "❌ Please enter a landmark.";
        return;
    }
    if(!radius.value || radius.value <= 0){
        msg.style.color = "red";
        msg.innerHTML = "❌ Radius must be greater than 0.";
        return;
    }
    if(!valid_minutes.value || valid_minutes.value <= 0){
        msg.style.color = "red";
        msg.innerHTML = "❌ Valid minutes must be greater than 0.";
        return;
    }
    if(!window.pick_lat){
        msg.style.color = "red";
        msg.innerHTML = "❌ Please click on the map to select a location.";
        return;
    }

    let data = {
        landmark: landmark.value.trim(),
        latitude: window.pick_lat,
        longitude: window.pick_lng,
        radius: radius.value,
        valid_minutes: valid_minutes.value
    };

    console.log("Sending Geofence Data Request:", data);

    fetch("/api/master/set_geofence", {
        method:"POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(d => {
        console.log("Geofence API Response:", d);

        msg.innerHTML = d.message;
        msg.style.color = d.success ? "green" : "red";

        if(d.success){
            landmark.value = "";
        }

        loadHistory();
    })
    .catch(err => {
        console.error("SAVE ERROR:", err);
        msg.style.color = "red";
        msg.innerHTML = "❌ Error saving geofence.";
    });
}

/* ------------------------ LOAD HISTORY ------------------------ */
function loadHistory(){
    fetch("/api/master/geofences")
    .then(r => r.json())
    .then(res => {
        console.log("History:", res);

        let tb = document.getElementById("geoTable");
        tb.innerHTML = "";

        res.data.forEach(row=>{
            tb.innerHTML += `
                <tr>
                    <td>${row.landmark}</td>
                    <td>${row.latitude}</td>
                    <td>${row.longitude}</td>
                    <td>${row.created_at || "-"}</td>
                    <td>${row.expires_at || "-"}</td>
                    <td>${row.attendance_count ?? 0}</td>
                </tr>
            `;
        });
    });
}

initMap();
loadHistory();
</script>

{% endblock %}
